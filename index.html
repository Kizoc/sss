<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>订阅解码・重命名・上传工具</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Verdana, sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #80deea);
      color: #333;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
    }
    h2 {
      font-weight: 700; font-size: 2.2rem; text-align: center; margin-bottom: 10px;
      color: #0277bd;
    }
    label {
      width: 100%; max-width: 800px;
      font-weight: 600; margin-bottom: 5px;
    }
    input, select, textarea, button {
      width: 100%; max-width: 800px;
      padding: 10px 15px;
      font-size: 1rem;
      border: none; border-radius: 8px;
      box-sizing: border-box;
      margin-bottom: 15px;
    }
    input, select, textarea {
      background: #ffffff;
      color: #333;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    textarea {
      height: 200px;
      font-family: monospace;
      resize: vertical;
    }
    textarea:focus, input:focus, select:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0,150,136,0.3);
    }
    .button-row {
      display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
    }
    button {
      background: #0288d1;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      padding: 12px 20px;
      transition: background 0.3s ease;
      min-height: 40px;
    }
    button:hover {
      background: #0277bd;
    }
    #status {
      max-width: 800px;
      min-height: 24px;
      text-align: center;
      color: #d84315;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h2>订阅解码・重命名・上传工具</h2>

  <!-- 步骤 1：输入订阅 -->
  <label>步骤1：输入订阅链接 或 粘贴内容（支持Base64解码）</label>
  <input id="subInput" placeholder="https://example.com/sub 或 粘贴订阅内容" />

  <!-- 解码按钮 -->
  <div class="button-row">
    <button onclick="decodeWithWorker()">用 Worker 解码</button>
    <button onclick="decodeDirect()">本地直连解码</button>
  </div>

  <label>解码结果</label>
  <textarea id="decodedArea" readonly placeholder="解码后的节点将在这里显示"></textarea>

  <!-- 步骤2：重命名 -->
  <button onclick="renameNodes()">步骤2：批量重命名节点</button>
  <label>重命名结果</label>
  <textarea id="renamedArea" readonly placeholder="重命名后的节点将在这里显示"></textarea>

  <!-- 步骤3：上传配置 -->
  <label>步骤3：填写 GitHub Token</label>
  <input id="tokenInput" placeholder="GitHub Token" />

  <label>选择上传目标文件夹（1–100）</label>
  <select id="folderSelect"></select>

  <div class="button-row">
    <button onclick="uploadToGitHub()">步骤4：上传到 GitHub</button>
  </div>

  <div id="status"></div>

  <script>
    // 准备folderSelect
    const sel = document.getElementById('folderSelect');
    for(let i=1;i<=100;i++){
      let o = document.createElement('option');
      o.value = `${i}.txt`;
      o.text = `${i}.txt`;
      sel.add(o);
    }

    // 国家列表（简化）
    const allCountries = [/* ...你的国家列表... */];

    function extractCountry(text){
      for(const c of allCountries){
        if(text.includes(c)) return c;
      }
      return null;
    }
    function formatRemark(country, order){
      return country ? `帅比｜高速｜${country}` : `无法识别-${order}｜帅比｜高速`;
    }

    // Worker解码
    async function decodeWithWorker(){
      const url = subInput.value.trim();
      status.textContent = "";
      if(!url){ alert("请输入内容"); return; }
      decodedArea.value = "请求中...";
      try {
        const proxy = 'https://proxy-worker.kizoc369.workers.dev/?url=';
        const r = await fetch(proxy + encodeURIComponent(url));
        if(!r.ok) throw new Error(r.status);
        const t = await r.text();
        try {
          decodedArea.value = atob(t.trim());
          status.textContent = "✔ Worker + Base64 解码成功";
        }catch{
          decodedArea.value = t;
          status.textContent = "✔ Worker 解码成功（非Base64）";
        }
      } catch(e){
        status.textContent = "✖ 解码失败：" + e.message;
      }
    }
    async function decodeDirect(){
      const url = subInput.value.trim();
      status.textContent = "";
      if(!url){ alert("请输入内容"); return; }
      decodedArea.value = "请求中...";
      try {
        const r = await fetch(url);
        if(!r.ok) throw new Error(r.status);
        const t = await r.text();
        try {
          decodedArea.value = atob(t.trim());
          status.textContent = "✔ 直连 + Base64 解码成功";
        }catch{
          decodedArea.value = t;
          status.textContent = "✔ 直连解码成功（非Base64）";
        }
      } catch(e){
        status.textContent = "✖ 解码失败：" + e.message;
      }
    }

    // 重命名逻辑
    function renameNodes(){
      const arr = decodedArea.value.trim().split('\n').filter(l=>l.trim());
      let order=1;
      const known=[], unknown=[];
      arr.forEach(line=>{
        let country=null, outLine=line;
        try {
          if(line.startsWith('vmess://')){
            const obj=JSON.parse(atob(line.slice(8)))
            country = extractCountry(obj.ps||"");
            obj.ps=formatRemark(country,order);
            outLine='vmess://'+btoa(JSON.stringify(obj));
          } else {
            const m = line.match(/^(\w+):\/\/([^#]+)(?:#(.*))?/)
            if(m){
              const pr = m[1], rest = m[2], rm = decodeURIComponent(m[3]||"");
              country=extractCountry(rm);
              outLine = pr+'://'+rest+'#'+encodeURIComponent(formatRemark(country,order));
            }
          }
        } catch{ }
        country ? known.push(outLine) : unknown.push(outLine);
        order++;
      });
      renamedArea.value = known.concat(unknown).join('\n');
      status.textContent = `✔ 重命名完成：共 ${arr.length} 条，未知国家 ${unknown.length} 条`;
    }

    // 获取 GitHub 用户名
    async function getUser(token){
      try{
        const r=await fetch('https://api.github.com/user',{headers:{Authorization:'token '+token}});
        if(!r.ok) throw '';
        return (await r.json()).login;
      }catch{return null;}
    }

    // 上传
    async function uploadToGitHub(){
      const tkn = tokenInput.value.trim();
      const data = renamedArea.value.trim();
      const folder = folderSelect.value;
      status.textContent = "";
      if(!tkn){ alert("请输入 Token"); return; }
      if(!data){ alert("请先重命名"); return; }
      status.textContent = "上传中...";

      const user = await getUser(tkn);
      if(!user){ status.textContent="✖ 无效 Token"; return; }

      const path = `${folder}/index.html`;
      const content = btoa(unescape(encodeURIComponent(data)));
      let sha = null;

      try{
        const r=await fetch(`https://api.github.com/repos/${user}/sss/contents/${path}`,
          {headers:{Authorization:`token ${tkn}`}});
        if(r.ok) sha=(await r.json()).sha;
        else if(r.status!==404){ throw r.status; }
      }catch(e){
        status.textContent = "✖ 获取文件信息失败";
        return;
      }

      const body={message:"自动上传节点",content,branch:"main"};
      if(sha) body.sha=sha;

      try{
        const r=await fetch(`https://api.github.com/repos/${user}/sss/contents/${path}`,
          {
            method:'PUT',
            headers:{Authorization:`token ${tkn}`, 'Content-Type':'application/json'},
            body:JSON.stringify(body)
          });
        if(r.ok){
          status.textContent = "✔ 上传成功！路径：" + `https://${user}.github.io/sss/${folder}/`;
        } else {
          status.textContent = "✖ 上传失败：" + ((await r.json()).message);
        }
      }catch(e){
        status.textContent = "✖ 上传异常：" + e.message;
      }
    }
  </script>
</body>
</html>
